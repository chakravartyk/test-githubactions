name: 'test conditional'
on:
  push:
  workflow_dispatch:
    inputs:
      tfenv:
        description: 'Environment to run terrafom tfstate'
        required: true
        default: env1
      project_alias:
        description: 'Project Identifier'
        default: pilot
        required: true
env:
  SECRET: GCP_SA_KEY_PILOT

permissions:
  contents: read

jobs:
  terraform:
    name: 'TestDynamicInput'
    runs-on: ubuntu-latest
    environment: gcp
    outputs:
      path: ${{ steps.version.outputs.propStr }}
      secret: ${{ steps.get_secret.outputs.propStr }}
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: get version
      id: version
      uses: notiz-dev/github-action-json-property@release
      with:
        path: '${{ github.workspace }}/folder/keyfile.json'
        prop_path: '${{ inputs.project_alias}}.environments.${{ inputs.tfenv }}.prefix'
    - name: get secret
      id: get_secret
      uses: notiz-dev/github-action-json-property@release
      with:
        path: '${{ github.workspace }}/folder/keyfile.json'
        prop_path: '${{ inputs.project_alias}}.environments.${{ inputs.tfenv }}.github_secret'
  verify_output:
    name: Verify
    runs-on: ubuntu-latest
    needs: ['terraform']
    env:
      SECRET: ${{ needs.terraform.outputs.secret }}
      PATH: ${{ needs.terraform.outputs.path }}
    steps:
        - name: Output value
          run: |
            echo $PATH
            echo $SECRET
        - name: Echo secret
          shell: bash
          run: |
            echo ${{ secrets[env.SECRET] }}
